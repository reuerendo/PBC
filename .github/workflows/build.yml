name: Build PocketBook Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential wget unzip
    
    - name: Download and setup PocketBook SDK
      run: |
        mkdir -p SDK
        cd SDK
        # Download the SDK archive
        wget http://ftp.obreey.com/SDK/SDK_6.3.0.zip
        unzip -q SDK_6.3.0.zip
        # Verify the structure
        ls -la
        ls -la SDK_6.3.0/ || true
        ls -la SDK_6.3.0/SDK-B288/ || true
    
    - name: Setup SDK environment
      run: |
        # Create symbolic links for compatibility
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libmpfr.so.6 /usr/lib/x86_64-linux-gnu/libmpfr.so.4 || true
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libgmp.so.10 /usr/lib/x86_64-linux-gnu/libgmp.so.3 || true
        sudo ldconfig
        
        # Make compiler executable
        chmod +x SDK/SDK_6.3.0/SDK-B288/bin/arm-obreey-linux-gnueabi-gcc || true
        chmod +x SDK/SDK_6.3.0/SDK-B288/bin/arm-obreey-linux-gnueabi-g++ || true
        chmod +x SDK/SDK_6.3.0/SDK-B288/bin/arm-obreey-linux-gnueabi-strip || true
    
    - name: Verify SDK structure
      run: |
        echo "=== SDK Structure ==="
        find SDK -name "arm-obreey-linux-gnueabi-gcc" || echo "Compiler not found!"
        echo "=== Checking toolchain file expectations ==="
        cat toolchain.cmake
    
    - name: Create build directory
      run: mkdir -p build
    
    - name: Configure CMake
      run: |
        cd build
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_VERBOSE_MAKEFILE=ON
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release --verbose
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: calibre-companion
        path: build/calibre-companion.app
        if-no-files-found: error
        
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: build/calibre-companion.app
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
